parameters:
  jobName: 'DeployNuget'
  jobDisplayName: 'Deploy to Nuget'
  pool: 'Default'
  artifactName: 'nuget'
  publishFeedCredentials: ''
  allowPackageConflicts: true

jobs:
  - deployment: ${{ parameters.jobName }}
    displayName: ${{ parameters.jobDisplayName }}
    pool: ${{ parameters.pool }}
    variables:
        nugetVersion: "t"
        allowPackageConflicts: ${{ parameters.allowPackageConflicts }}
    environment: PreviewAzure
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@1
            inputs:
              artifactName: ${{ parameters.artifactName }}
              targetPath: $(Build.ArtifactStagingDirectory)

          - task: Powershell@2
            name: setNugetIsDuplicateVar
            displayName: 'Nuget Conflict Check'
            inputs:
              targetType: inline
              script: |
                 . $(Build.SourcesDirectory)/build/Get-IsDuplicateNugetPackage.ps1
                  
                  $isDuplicate = Get-IsDuplicateNugetPackage -PackageId "LCattell.ReflectionExtensions" -Version "$env:GitVersion_NuGetVersionV2";
                   
                  echo "##vso[task.setvariable variable=isDuplicate]$isDuplicate";

                  Write-Debug $isDuplicate;
            condition: eq(variables['allowPackageConflicts'], 'true')

          - task: NuGetCommand@2
            displayName: Publish to Nuget
            inputs:
              command: 'push'
              packagesToPush: '$(Build.ArtifactStagingDirectory)/**/*.nupkg;!$(Build.ArtifactStagingDirectory)/**/*.symbols.nupkg'
              nuGetFeedType: 'external'
              publishFeedCredentials: ${{ parameters.publishFeedCredentials }}
              allowPackageConflicts: ${{ parameters.allowPackageConflicts }}
          condition: ne(variables['isDuplicate'], 'true')
    condition: > 
      and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), 
        or(eq(variables['Build.SourceBranch'], 'refs/heads/master'),
          startswith(variables['Build.SourceBranch'], 'refs/heads/release/'),
          startswith(variables['Build.SourceBranch'], 'refs/heads/azure-pipelines-test')) )